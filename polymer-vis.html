<link rel="import" href="../polymer/polymer-element.html">

<script src="./bower_components/vis/dist/vis.js"></script>

<dom-module id="polymer-vis">
  <link rel="import" type="css" href-"./bower_components/vis/dist/vis-timeline-graph2d.min.css">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }
      #visualization {
        width: 100%;
        height: 100%;
      }

      .vis-time-axis {
        position: relative;
        overflow: hidden;
      }

      .vis-time-axis.vis-foreground {
        top: 0;
        left: 0;
        width: 100%;
      }

      .vis-time-axis.vis-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .vis-time-axis .vis-text {
        position: absolute;
        color: #4d4d4d;
        padding: 3px;
        overflow: hidden;
        box-sizing: border-box;

        white-space: nowrap;
      }

      .vis-time-axis .vis-text.vis-measure {
        position: absolute;
        padding-left: 0;
        padding-right: 0;
        margin-left: 0;
        margin-right: 0;
        visibility: hidden;
      }

      .vis-time-axis .vis-grid.vis-vertical {
        position: absolute;
        border-left: 1px solid;
      }

      .vis-time-axis .vis-grid.vis-vertical-rtl {
        position: absolute;
        border-right: 1px solid;
      }

      .vis-time-axis .vis-grid.vis-minor {
        border-color: #e5e5e5;
      }

      .vis-time-axis .vis-grid.vis-major {
        border-color: #bfbfbf;
      }

      .vis-timeline {
        position: relative;
        border: 1px solid #bfbfbf;

        overflow: hidden;
        padding: 0;
        margin: 0;

        box-sizing: border-box;
      }
      .vis-graph-group0 {
        fill:#4f81bd;
        fill-opacity:0;
        stroke-width:2px;
        stroke: #4f81bd;
      }

      .vis-graph-group1 {
          fill:#f79646;
          fill-opacity:0;
          stroke-width:2px;
          stroke: #f79646;
      }

      .vis-graph-group2 {
          fill: #8c51cf;
          fill-opacity:0;
          stroke-width:2px;
          stroke: #8c51cf;
      }

      .vis-graph-group3 {
          fill: #75c841;
          fill-opacity:0;
          stroke-width:2px;
          stroke: #75c841;
      }

      .vis-graph-group4 {
          fill: #ff0100;
          fill-opacity:0;
          stroke-width:2px;
          stroke: #ff0100;
      }

      .vis-graph-group5 {
          fill: #37d8e6;
          fill-opacity:0;
          stroke-width:2px;
          stroke: #37d8e6;
      }

      .vis-graph-group6 {
          fill: #042662;
          fill-opacity:0;
          stroke-width:2px;
          stroke: #042662;
      }

      .vis-graph-group7 {
          fill:#00ff26;
          fill-opacity:0;
          stroke-width:2px;
          stroke: #00ff26;
      }

      .vis-graph-group8 {
          fill:#ff00ff;
          fill-opacity:0;
          stroke-width:2px;
          stroke: #ff00ff;
      }

      .vis-graph-group9 {
          fill: #8f3938;
          fill-opacity:0;
          stroke-width:2px;
          stroke: #8f3938;
      }

      .vis-timeline .vis-fill {
          fill-opacity:0.1;
          stroke: none;
      }


      .vis-timeline .vis-bar {
          fill-opacity:0.5;
          stroke-width:1px;
      }

      .vis-timeline .vis-point {
          stroke-width:2px;
          fill-opacity:1.0;
      }


      .vis-timeline .vis-legend-background {
          stroke-width:1px;
          fill-opacity:0.9;
          fill: #ffffff;
          stroke: #c2c2c2;
      }


      .vis-timeline .vis-outline {
          stroke-width:1px;
          fill-opacity:1;
          fill: #ffffff;
          stroke: #e5e5e5;
      }

      .vis-timeline .vis-icon-fill {
          fill-opacity:0.3;
          stroke: none;
      }

      .vis-panel {
        position: absolute;

        padding: 0;
        margin: 0;

        box-sizing: border-box;
      }

      .vis-panel.vis-center,
      .vis-panel.vis-left,
      .vis-panel.vis-right,
      .vis-panel.vis-top,
      .vis-panel.vis-bottom {
        border: 1px #bfbfbf;
      }

      .vis-panel.vis-center,
      .vis-panel.vis-left,
      .vis-panel.vis-right {
        border-top-style: solid;
        border-bottom-style: solid;
        overflow: hidden;
      }

      .vis-left.vis-panel.vis-vertical-scroll, .vis-right.vis-panel.vis-vertical-scroll {
        height: 100%;
        overflow-x: hidden;
        overflow-y: scroll;
      } 

      .vis-left.vis-panel.vis-vertical-scroll {
        direction: rtl;
      }

      .vis-left.vis-panel.vis-vertical-scroll .vis-content {
        direction: ltr;
      }

      .vis-right.vis-panel.vis-vertical-scroll {
        direction: ltr;
      }

      .vis-right.vis-panel.vis-vertical-scroll .vis-content {
        direction: rtl;
      }

      .vis-panel.vis-center,
      .vis-panel.vis-top,
      .vis-panel.vis-bottom {
        border-left-style: solid;
        border-right-style: solid;
      }

      .vis-background {
        overflow: hidden;
      }

      .vis-panel > .vis-content {
        position: relative;
      }

      .vis-panel .vis-shadow {
        position: absolute;
        width: 100%;
        height: 1px;
        box-shadow: 0 0 10px rgba(0,0,0,0.8);
        /* TODO: find a nice way to ensure vis-shadows are drawn on top of items
        z-index: 1;
        */
      }

      .vis-panel .vis-shadow.vis-top {
        top: -1px;
        left: 0;
      }

      .vis-panel .vis-shadow.vis-bottom {
        bottom: -1px;
        left: 0;
      }

      .vis-labelset {
        position: relative;

        overflow: hidden;

        box-sizing: border-box;
      }

      .vis-labelset .vis-label {
        position: relative;
        left: 0;
        top: 0;
        width: 100%;
        color: #4d4d4d;

        box-sizing: border-box;
      }

      .vis-labelset .vis-label {
        border-bottom: 1px solid #bfbfbf;
      }

      .vis-labelset .vis-label.draggable {
        cursor: pointer;
      }

      .vis-labelset .vis-label:last-child {
        border-bottom: none;
      }

      .vis-labelset .vis-label .vis-inner {
        display: inline-block;
        padding: 5px;
      }

      .vis-labelset .vis-label .vis-inner.vis-hidden {
        padding: 0;
      }

      .vis-itemset {
        position: relative;
        padding: 0;
        margin: 0;

        box-sizing: border-box;
      }

      .vis-itemset .vis-background,
      .vis-itemset .vis-foreground {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: visible;
      }

      .vis-axis {
        position: absolute;
        width: 100%;
        height: 0;
        left: 0;
        z-index: 1;
      }

      .vis-foreground .vis-group {
        position: relative;
        box-sizing: border-box;
        border-bottom: 1px solid #bfbfbf;
      }

      .vis-foreground .vis-group:last-child {
        border-bottom: none;
      }

      .vis-nesting-group {
        cursor: pointer;
      }

      .vis-nested-group {
        background: #f5f5f5;
      }

      .vis-label.vis-nesting-group.expanded:before {
        content: "\25BC";
      }

      .vis-label.vis-nesting-group.collapsed-rtl:before {
        content: "\25C0";
      }

      .vis-label.vis-nesting-group.collapsed:before {
        content: "\25B6";
      }

      .vis-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
      }

      .vis-item {
        position: absolute;
        color: #1A1A1A;
        border-color: #97B0F8;
        border-width: 1px;
        background-color: #D5DDF6;
        display: inline-block;
        z-index: 1;
        /*overflow: hidden;*/
      }

      .vis-item.vis-selected {
        border-color: #FFC200;
        background-color: #FFF785;

        /* z-index must be higher than the z-index of custom time bar and current time bar */
        z-index: 2;
      }

      .vis-editable.vis-selected {
        cursor: move;
      }

      .vis-item.vis-point.vis-selected {
        background-color: #FFF785;
      }

      .vis-item.vis-box {
        text-align: center;
        border-style: solid;
        border-radius: 2px;
      }

      .vis-item.vis-point {
        background: none;
      }

      .vis-item.vis-dot {
        position: absolute;
        padding: 0;
        border-width: 4px;
        border-style: solid;
        border-radius: 4px;
      }

      .vis-item.vis-range {
        border-style: solid;
        border-radius: 2px;
        box-sizing: border-box;
      }

      .vis-item.vis-background {
        border: none;
        background-color: rgba(213, 221, 246, 0.4);
        box-sizing: border-box;
        padding: 0;
        margin: 0;
      }

      .vis-item .vis-item-overflow {
        position: relative;
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        overflow: hidden;
      }

      .vis-item-visible-frame {
        white-space: nowrap;
      }

      .vis-item.vis-range .vis-item-content {
        position: relative;
        display: inline-block;
      }

      .vis-item.vis-background .vis-item-content {
        position: absolute;
        display: inline-block;
      }

      .vis-item.vis-line {
        padding: 0;
        position: absolute;
        width: 0;
        border-left-width: 1px;
        border-left-style: solid;
      }

      .vis-item .vis-item-content {
        white-space: nowrap;
        box-sizing: border-box;
        padding: 5px;
      }

      .vis-item .vis-onUpdateTime-tooltip {
        position: absolute;
        background: #4f81bd;
        color: white;
        width: 200px;
        text-align: center;
        white-space: nowrap;
        padding: 5px;
        border-radius: 1px;
        transition: 0.4s;
        -o-transition: 0.4s;
        -moz-transition: 0.4s;
        -webkit-transition: 0.4s;
      }

      .vis-item .vis-delete, .vis-item .vis-delete-rtl {
        position: absolute;
        top: 0px;
        width: 24px;
        height: 24px;
        box-sizing: border-box;
        padding: 0px 5px;
        cursor: pointer;

        -webkit-transition: background 0.2s linear;
        -moz-transition: background 0.2s linear;
        -ms-transition: background 0.2s linear;
        -o-transition: background 0.2s linear;
        transition: background 0.2s linear;
      }

      .vis-item .vis-delete {
        right: -24px;
      }

      .vis-item .vis-delete-rtl {
        left: -24px;
      }

      .vis-item .vis-delete:after, .vis-item .vis-delete-rtl:after {
        content: "\00D7"; /* MULTIPLICATION SIGN */
        color: red;
        font-family: arial, sans-serif;
        font-size: 22px;
        font-weight: bold;

        -webkit-transition: color 0.2s linear;
        -moz-transition: color 0.2s linear;
        -ms-transition: color 0.2s linear;
        -o-transition: color 0.2s linear;
        transition: color 0.2s linear;
      }

      .vis-item .vis-delete:hover, .vis-item .vis-delete-rtl:hover {
        background: red;
      }

      .vis-item .vis-delete:hover:after, .vis-item .vis-delete-rtl:hover:after {
        color: white;
      }

      .vis-item .vis-drag-center {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0px;
        cursor: move;
      }

      .vis-item.vis-range .vis-drag-left {
        position: absolute;
        width: 24px;
        max-width: 20%;
        min-width: 2px;
        height: 100%;
        top: 0;
        left: -4px;

        cursor: w-resize;
      }

      .vis-item.vis-range .vis-drag-right {
        position: absolute;
        width: 24px;
        max-width: 20%;
        min-width: 2px;
        height: 100%;
        top: 0;
        right: -4px;

        cursor: e-resize;
      }

      .vis-range.vis-item.vis-readonly .vis-drag-left,
      .vis-range.vis-item.vis-readonly .vis-drag-right {
        cursor: auto;
      }

      .vis-panel.vis-background.vis-horizontal .vis-grid.vis-horizontal {
        position: absolute;
        width: 100%;
        height: 0;
        border-bottom: 1px solid;
      }

      .vis-panel.vis-background.vis-horizontal .vis-grid.vis-minor {
        border-color: #e5e5e5;
      }

      .vis-panel.vis-background.vis-horizontal .vis-grid.vis-major {
        border-color: #bfbfbf;
      }


      .vis-data-axis .vis-y-axis.vis-major {
        width: 100%;
        position: absolute;
        color: #4d4d4d;
        white-space: nowrap;
      }

      .vis-data-axis .vis-y-axis.vis-major.vis-measure {
        padding: 0;
        margin: 0;
        border: 0;
        visibility: hidden;
        width: auto;
      }


      .vis-data-axis .vis-y-axis.vis-minor {
        position: absolute;
        width: 100%;
        color: #bebebe;
        white-space: nowrap;
      }

      .vis-data-axis .vis-y-axis.vis-minor.vis-measure {
        padding: 0;
        margin: 0;
        border: 0;
        visibility: hidden;
        width: auto;
      }

      .vis-data-axis .vis-y-axis.vis-title {
        position: absolute;
        color: #4d4d4d;
        white-space: nowrap;
        bottom: 20px;
        text-align: center;
      }

      .vis-data-axis .vis-y-axis.vis-title.vis-measure {
        padding: 0;
        margin: 0;
        visibility: hidden;
        width: auto;
      }

      .vis-data-axis .vis-y-axis.vis-title.vis-left {
        bottom: 0;
        -webkit-transform-origin: left top;
        -moz-transform-origin: left top;
        -ms-transform-origin: left top;
        -o-transform-origin: left top;
        transform-origin: left bottom;
        -webkit-transform: rotate(-90deg);
        -moz-transform: rotate(-90deg);
        -ms-transform: rotate(-90deg);
        -o-transform: rotate(-90deg);
        transform: rotate(-90deg);
      }

      .vis-data-axis .vis-y-axis.vis-title.vis-right {
        bottom: 0;
        -webkit-transform-origin: right bottom;
        -moz-transform-origin: right bottom;
        -ms-transform-origin: right bottom;
        -o-transform-origin: right bottom;
        transform-origin: right bottom;
        -webkit-transform: rotate(90deg);
        -moz-transform: rotate(90deg);
        -ms-transform: rotate(90deg);
        -o-transform: rotate(90deg);
        transform: rotate(90deg);
      }

      .vis-legend {
        background-color: rgba(247, 252, 255, 0.65);
        padding: 5px;
        border: 1px solid #b3b3b3;
        box-shadow: 2px 2px 10px rgba(154, 154, 154, 0.55);
      }

      .vis-legend-text {
        /*font-size: 10px;*/
        white-space: nowrap;
        display: inline-block
      }

      .vis-custom-time {
        background-color: #6E94FF;
        width: 2px;
        cursor: move;
        z-index: 1;
      }

      .vis-current-time {
        background-color: #FF7F6E;
        width: 2px;
        z-index: 1;
        pointer-events: none;
      }

      .vis-rolling-mode-btn {
        height: 40px;
        width: 40px;
        position: absolute;
        top: 7px;
        right: 20px;
        border-radius: 50%;
        font-size: 28px;
        cursor: pointer;
        opacity: 0.8;
        color: white;
        font-weight: bold;
        text-align: center;
        background: #3876c2;
      }
      .vis-rolling-mode-btn:before {
        content: "\26F6";
      }

      .vis-rolling-mode-btn:hover {
        opacity: 1;
      }
    </style>
    <div id="visualisation"></div>
  </template>

  <script>
    /**
     * `polymer-vis`
     * A Polymer element for working with vis.js
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class PolymerVis extends Polymer.Element {
      static get is() { return 'polymer-vis'; }
      static get properties() {
        return {
          prop1: {
            type: String,
            value: 'polymer-vis'
          }
        };
      }

      ready() {
        super.ready();
      }

      connectedCallback () {
        super.connectedCallback();

        var container = this.$.visualisation;
        this.dummydataset = new vis.DataSet();
        var options = {
          start: vis.moment().add(-30, 'seconds'), // changed so its faster
          end: vis.moment(),
          dataAxis: {
            left: {
              range: {
                min:0, max: 10
              }
            }
          },
          drawPoints: {
            style: 'circle' // square, circle
          },
          shaded: {
            orientation: 'bottom' // top, bottom
          }
        };
        this.graph2d = new vis.Graph2d(container, this.dummydataset, options);

        this.addDataPoint();
        this.renderStep();
      }

      // a function to generate data points
      randy(x) {
        return (Math.sin(x / 2) + Math.cos(x / 4)) * 5;
      }

      poll(event) {
        const iron_ajax = this.$.iron_ajax;
        setTimeout(function() {
          iron_ajax.generateRequest();
        }, 1000);
      }

      renderStep() {
        // move the window (you can think of different strategies).
        var now = vis.moment();
        var range = this.graph2d.getWindow();
        var interval = range.end - range.start;
        // move the window 90% to the left when now is larger than the end of the window
        if (now > range.end) {
          this.graph2d.setWindow(now - 0.1 * interval, now + 0.9 * interval);
        }
        setTimeout(this.renderStep.bind(this), 1000);
      }

      /**
       * Add a new datapoint to the graph
       */
      addDataPoint() {
        // add a new data point to the dummydataset
        var now = vis.moment();
        this.dummydataset.add({
          x: now,
          y: this.randy(Math.random())
        });

        // remove all data points which are no longer visible
        var range = this.graph2d.getWindow();
        var interval = range.end - range.start;
        var oldIds = this.dummydataset.getIds({
          filter: function (item) {
            return item.x < range.start - interval;
          }
        });
        this.dummydataset.remove(oldIds);

        setTimeout(this.addDataPoint.bind(this), 1000);
      }
    }

    window.customElements.define(PolymerVis.is, PolymerVis);
  </script>
</dom-module>
